
name: alpine:3.12

on:
  push:
    branches: ['*']
    tags: ['*']

jobs:

  create-release:
    name: Create release

    runs-on: ubuntu-latest

    outputs:
      id: ${{ steps.create-release.outputs.id }}
      upload_url: ${{ steps.create-release.outputs.upload_url }}
      release_name: ${{ steps.generate-release-name.outputs.release_name }}

    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Generate release name
      id: generate-release-name
      run: |
        case "${{ github.ref }}" in
          refs/tags/*)
            release_name="$(echo ${{ github.ref }} | sed 's/.*\/\(.*\)$/\1/')"
            ;;
          *)
            release_name="$(echo ${{ github.ref }} | sed 's/.*\/\(.*\)$/\1/')-$(git rev-parse --short HEAD)"
            ;;
        esac
        echo "::set-output name=release_name::${release_name}"

    - name: Create Release
      id: create-release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: ${{ steps.generate-release-name.outputs.release_name }}
        draft: true
        prerelease: ${{ !startsWith(github.event.ref, 'refs/tags/') }}

  build-containers:
    name: |
      ${{ matrix.platform }}
    runs-on: ubuntu-latest

    needs: create-release

    strategy:
      matrix:
        platform:
          - "linux/amd64"
          - "linux/386"
          - "linux/arm/v6"
          - "linux/arm/v7"
          - "linux/arm64/v8"
          - "linux/ppc64le"
          - "linux/s390x"

    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Restore cached sources
      uses: actions/cache@v2
      with:
        path: sources
        key: sources

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GHCR_PERSONAL_ACCESS_TOKEN }}

    - name: Build & push container image
      run: |
        ./build-container.sh \
          "alpine3.12" \
          "$(basename ${{ github.event.ref }})" \
          "${{ matrix.platform }}"

  build-toolchains:
    name: |
      ${{ matrix.platform }}: ${{ matrix.toolchain }}

    runs-on: ubuntu-latest

    needs:
      - create-release
      - build-containers

    strategy:
      matrix:
        platform:
          - "linux/amd64"
          - "linux/386"
          - "linux/arm/v6"
          - "linux/arm/v7"
          - "linux/arm64/v8"
          - "linux/ppc64le"
          - "linux/s390x"
        toolchain:
          - "aarch64-alpine3.12-linux-musl"
          - "armv6-alpine3.12-linux-musleabi"
          - "armv7-alpine3.12-linux-musleabihf"
          - "i686-alpine3.12-linux-musl"
          - "powerpc64le-alpine3.12-linux-musl"
          - "s390x-alpine3.12-linux-musl"
          - "x86_64-alpine3.12-linux-musl"

    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Restore cached sources
      uses: actions/cache@v2
      with:
        path: sources
        key: sources

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GHCR_PERSONAL_ACCESS_TOKEN }}

    - name: Build toolchain
      id: build-toolchain
      run: |
        ./build-and-package-toolchain.sh \
          "alpine3.12" \
          "$(basename ${{ github.event.ref }})" \
          "${{ needs.create-release.outputs.release_name }}" \
          "${{ matrix.platform }}" \
          "${{ matrix.toolchain }}"

    - name: Attach toolchain tarball to release
      id: upload-release-asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: "${{ needs.create-release.outputs.upload_url }}"
        asset_path: "${{ steps.build-toolchain.outputs.asset_path }}"
        asset_name: "${{ steps.build-toolchain.outputs.asset_name }}"
        asset_content_type: application/x-xz

  publish-release:
    if: ${{ startsWith(github.event.ref, 'refs/tags/') }}
    runs-on: ubuntu-latest
    needs:
      - create-release
      - build-containers
      - build-toolchains
    steps:
    - uses: eregon/publish-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        release_id: ${{ needs.create-release.outputs.id }}
